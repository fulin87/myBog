---
layout: post
title:  "mysql一次性删除千万级别记录引发的问题和思考"
date:	2017-02-24 13:07:11 +0800
categories: php
---

* Table of Contents
{:toc}

> 昨天，一位同事在A系统的测试环境的mysql数据库中执行了一条`DELETE` 语句，删除了一千多万条数据，导致监控平台告警，数据库服务器磁盘空间被占满,对于这件事，我们是需要思考和总结的。

 ![](/image/mysqlDelete.PNG)

### 为什么会出现磁盘被占满的情况
	
 在`mysql`数据库中,`UPDATE,DELETE,INSERT`操作都会记录到一个二进制日志文件中,也就是大家平时所说的`binlog`,这个日志文件的格式与mysql的一个参数设置有关。

 `binlog`有很多用途：

	* 根据binlog进行主从同步（常用）
	* 根据binlog进行数据恢复（不常用）
	* 可以用来查询数据库的操作记录

 因此，大量的DML语句对参数大量的`binlog`,像上面的情况，一次删除千万级别的数据，参数的日志文件就有20多G，直接导致了磁盘被占满。
 
### 一次性删除大量数据产生的危害有哪些

 根据上面的分析可知，大量的DML操作参数的直接影响就是导致服务器磁盘被占满，其实还有另外一种更大的危害：`破坏数据库主从同步`导致数据库主从不一致，进而影响应用系统的逻辑。

### 删除数据正确的姿势是什么

	1，分批删除，观察磁盘占有情况和数据同步情况
	2，交给专业DBA执行

### 启示

 事情发生后，那位同事被领导批评了一顿，但是从这件事我们至少可以吸取两个教训：
	
	1，对数据库的操作，至少是DML操作应该有严格的流程限制，不能随便让人去执行，否则后果很严重
	2，作为程序员，数据库的知识要扎实，否则就会引来大麻烦。
